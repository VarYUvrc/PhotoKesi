# フォトケシ - 類似ショット整理

写真をたくさん撮るのは楽しいのに、「ほぼ同じ写真」が端末を圧迫していくのはつらい。
このアプリは、同じ時間帯に撮られた“よく似た写真”だけを自動で束ね、**最初からベスト1枚にチェックが入った状態**で上下二段の整理ボードに並べます。上段には「残す写真」としてチェック済み写真が並び、下段には「バケツ」として未チェックの写真が並びます。ユーザーは、**チェックが付いたものだけを残す**という単純なルールのまま、**バケツに溜まったものをまとめて空にする**→**最後に確認して削除**まで、一息で片づけられます。

* 画面は **メイン** と **設定** の二つだけ。
* **チェック＝残す、未チェック＝消す** をアプリ全体で統一。
* 処理は**端末内完結**。外部サービス連携なし、広告なし。
* **機械学習は使わず**、高速なロジック（ハッシュやヒストグラムなど）で類似を判定。
* 無料でも毎日すこしずつ整理でき、**有料プラン**で回数制限が外れ、**スクリーンショット整理**などが使えます。

---

## 対応環境
* iOS 17 / 18 / 26
* 開発・動作は iPhone 実機を前提（M4 Mac mini でビルド／配布）。
   * 開発環境のVSCodeと動作確認用のXcode環境導入済み

---

## 体験の流れ（メイン画面）

1. アプリを開くと、上下二列の整理ボードに **類似グループを 1 つだけ** 表示します。

   * 上段（残す写真）には、知覚ハッシュ距離・露出安定性・構図の中心度など複数の指標でベスト判定した 1 枚をチェック済みで初期表示し、サムネ上部に `best✨` バッジを重ねて強調します。チェックを外すと即座にバケツへ移動し、別の写真を残す写真に昇格できます。
   * 下段（バケツ）には、チェックが外れている写真が常に集まり、削除候補としてスタンバイします。誤って追加した写真は **上方向のスワイプ** やチェック操作で残す写真に戻せます。
   * 前後の撮影時刻が設定した時間幅内に連鎖して存在する写真だけが束ね対象になり、孤立した 1 枚きりの写真は整理ボードに表示されません。
   * メイン画面のサムネイルを **タップ** するとフルサイズの元写真ビューに遷移し、右上のトグルでチェックのオン・オフを切り替えられます（結果は即座に上下の列へ反映）。
   * 元写真ビューでは左上の戻るボタンでサムネ一覧へ戻れるほか、**左右スワイプ** で同じ束の別写真に移動し、**上方向へのスワイプ** でメイン画面へ戻ります。ピンチ操作は拡大に利用できます。
   * 右上の歯車アイコンから設定へ移動し、グルーピング時間幅（15〜240分・15分刻み）をその場で調整できます。
   * 有料プランでは、残す写真に **理由バッジ**（例：手ぶれが少ない、露出が安定している、被写体が中心にある）を表示します。
   * 画面サイズやダイナミックタイプの設定に応じてカードやボタンのサイズを自動調整し、メイン画面はスクロールなしで全ての操作が届くように最適化されています。

2. 右上のチェックやスワイプでバケツを整えたら、右下の **「仕分けを完了して次のグループへ」** ボタンを押します。バケツが空ならその場で次のグループへ移動し、バケツに1枚でも写真がある場合は **削除確認モーダル** が開きます。

   * モーダルではサムネイルがずらっと並び、ここでも **チェック＝残す、未チェック＝削除** のまま統一です。
   * 必要なら **全てチェック**／**全てチェック解除** を使って細かく調整し、
     **「削除確定」** ボタン（バケツアイコン付き）で確定します。
   * 実際の削除は iPhone の **「最近削除した項目」** に移動するだけなので、**約30日間は復元可能**です。
   * 確定直後は「○○枚を削除しました。最近削除した項目から約30日間は復元可能です」という標準風ポップアップを出します。

3. 進捗表示は **「現在までに見つかったグループ数 / 発見済みグループ総数」** を示します。
   裏で探索が進むため、**右側の母数は 4/35 → 5/42 → 6/43 のように動的に増える** ことがあります。
   小さな回転インジケータと説明ツールチップで「探索中」を伝えます。

> ポイント：**コールドスタートを避ける**ため、探索は段階的に進みます。最新の写真から優先して価値を出し、
> ユーザーが操作しているあいだも、端末負荷を見ながら穏やかに裏でグルーピングを増やしていきます。

---

## スクリーンショット整理（有料プラン）

メイン画面の左上にある **「スクリーンショット整理」** ボタンでモードを切り替えます。

* 無料プランでボタンを押すと、設定の「サブスクリプション」説明へ遷移して特徴を案内します。
* 有料プランでは、その場で **専用モード** に切り替わり、**背景色やカラーパレット** が変化します（切替に気づきやすい）。

このモードでは、**中央に現在のスクリーンショット**、**下に次の画像の上約 5% が見えている**レイアウトで、
**右スワイプ＝残す、左スワイプ＝削除** の直感的な選別ができます（左右は設定で入れ替え可能）。
一度「残す」にしたスクリーンショットにはフラグが付くので、**再起動後も二度と出ません**。
この「残すフラグ」「リセット」の考え方は、写真の類似グループ整理と**共通の挙動**です。

---

## 料金プラン（家族共有なし）

* **Free（無料）**

  * 類似グループの表示・チェック・バケツ投入は無制限
  * **削除確定（バケツ → 削除）は 1 日 3 回まで**（端末の暦で 0 時に自動リセット）
  * スクリーンショット整理モード：利用不可
  * 高精度モード：利用不可
  * 理由バッジ：表示なし

* **MAX（有料・サブスクリプション）**

  * 価格：**月 700 円**／**年 5,800 円**
  * 削除確定の回数制限なし
  * スクリーンショット整理モードが利用可能
  * 高精度モード（類似しきい値の調整域が広がり、判定が安定）
  * 理由バッジを表示
  * 週次のレポート通知（今週の削除枚数と推定の節約容量）
  * 画面上の文言：**「あなたの操作に応じて、判断が賢くなっていきます！」**

    * 実装は端末内の**重み・しきい値の微調整**のみ（機械学習モデルは使いません）。
    * 無料でも少量の調整は内部で行いますが、あえて告知しません。

**比較表は常時表示**です。設定画面の「サブスクリプション」セクションで、
Free と MAX を**表形式**で並べ、丸×で出来ること／出来ないことを明確に示します。
これにより、**解約を検討するユーザーが失う価値を可視化**し、離脱を抑えます。

---

## 類似判定の仕組み（機械学習なし）

1. **時間の近さ**で粗く束ねます（初期値は撮影時刻 ±1 時間。設定で調整可能）。前後の写真を芋づる式にたどり、連続して時間幅内にあるものだけを同じ束にします。孤立した写真は束に含めず、整理ボードにも表示しません。
2. 画像を縮小し、次の情報を計算して**見た目の近さ**を測ります。

   * **知覚ハッシュ**（pHash）と **差分ハッシュ**（dHash）のハミング距離
   * **色ヒストグラムの距離**（代表的な距離指標を使用）
   * 必要な場合のみ、縮小画像で **構造類似度（SSIM の簡易版）**
3. そのグループの中から **ベスト1枚** を選びます（最初からチェックが入る）。

   * 指標例：ブレの少なさ（ラプラシアンの分散）、露出の安定、構図の中心度（簡易的な注目領域から重心を推定）、ノイズ量、グループ中心性（代表性）
   * 有料プランでは、上位2〜3個の指標を **理由バッジ** として表示します。

> すべて端末内で完結します。写真データや指標はアプリの領域に暗号化して保存し、外部へ送信しません。

---

## バックグラウンドと負荷対策

* 進捗の右側の母数は、**探索が進むほど増えていく**設計です。
* 裏側の処理は **同時実行数を自動調整** し、端末の熱や電池の状態を見て **一時停止や減速** を行います。
* ユーザーがスクロールやピンチなどの操作をしている間は、裏処理を短時間止めます。
* フルの再探索は行わず、**差分スキャン** を基本とします。
* iOS の制約に合わせてバックグラウンド実行は控えめにし、**通知からの起動時**に差分だけ素早く処理します。

---

## フラグとリセット

* 「残す」にした写真やスクリーンショットには **フラグ** を付け、**再表示しません**。
* 写真の識別子が変わる場合に備え、**知覚ハッシュによる再照合**も使って誤再出現を抑えます。
* メインもスクリーンショット整理も、**同じデザインの「リセット」ボタン**を用意します。
  押すと確認ダイアログが出て、OK でフラグを全消去し、**再び全件が対象**に戻ります。

---

## 設定画面にあるもの（抜粋）

* サブスクリプション（比較表、購入、復元、解約導線）
* 本日の残り回数（無料プランのときのみ表示）
* これまでに削除して浮いた容量の合計（推定値）
* 類似判定の時間幅（初期 1 時間、15 分刻みで調整可能）
* 類似の強さ（低め／標準／強め）
* 通知（週 1 の棚卸し通知、未処理しきい値での通知）
* 整理対象の種類（写真／スクリーンショット）
* 判定のリセット（メイン／スクリーンショット共通）

---

## プライバシーと安全

* すべての計算と記録は **端末内** で行い、写真データを外部へ送りません。
* 初回起動時に写真ライブラリへのアクセス許可をリクエストし、限定アクセスでも利用を開始できます。設定アプリへの導線を用意し、完全アクセスを案内します。
* 削除は iPhone の **「最近削除した項目」** に移動するだけなので、**約30日間は復元可能**です。
* 誤操作が不安な人のために、削除前の **確認モーダル** を必須にしています。

---

## 非目標（当面やらないこと）

* クラウド連携、他社サービス連携
* 複雑な編集やレタッチ
* 写真以外のメディア（動画の高度編集など）の整理

---

## ライセンス・表記（案）

* アプリ内の「応援」リンクは任意で、機能とは連動しません。
* 商用利用に支障のないライブラリ（ハッシュ計算など）を選定し、第三者の権利に配慮します。

---

## 開発メモ

### 基本構成メモ

* フレームワーク：PhotoKit、Core Image、Accelerate（vImage / vDSP）
* サムネイル取得は `PhotoThumbnailCache` が `PHCachingImageManager` と `NSCache` を組み合わせ、非同期で縮小画像をキャッシュする。
* `PhotoLibraryViewModel` が `PHAsset` のフェッチとサムネイルの公開を担い、UI は実データを表示する。
* データ保存：アプリ内に暗号化して保存（指標やフラグ、統計値）
* 例外系：権限が限定のときでも最小限で動作し、完全アクセスを丁寧に案内

### ローディング体験の方針

* フェーズA2では実データのサムネイル取得とキャッシュ体制を整えた直後に、アプリ起動時専用のローディング画面を導入しました。SwiftUI標準のビューだけで構成し、アプリ名・簡単な進行説明・システムインジケータ程度に留め、重いアニメーションや外部ライブラリは使いません。権限確認や初回フェッチが完了したら速やかにメイン画面へ遷移します。
* フェーズA6で上下二列レイアウトを実装する際に、サムネイルが揃うまでの短時間だけ表示するスケルトンビューを追加します。`redacted(reason: .placeholder)` や単色の矩形コンポーネントを活用し、画像素材やSVGを新規に用意せず軽量に表現します。ビュー階層は既存のメイン画面構造を流用し、非表示化で切り替えられるようにして後続の仕様変更にも対応しやすくします。
* いずれも状態管理は既存のViewModelにブール値を足す程度で制御し、アプリ全体のレスポンスを損なわないことを優先します。

## このアプリが素晴らしい理由（まとめ）

* **考えなくてよい**：チェック＝残す、だけを覚えれば迷わない。
* **速い**：学習モデルを使わず、軽い指標と段階的探索でサクサク。
* **安心**：端末内完結。削除も 30 日の復元猶予つき。
* **続けやすい**：無料でも毎日 3 回進み、有料で一気に片づく。
* **気持ちよい**：スクリーンショットは左右スワイプでテンポよく選別。
* **二画面だけ**：メインと設定。迷路のようなタブはありません。

---
