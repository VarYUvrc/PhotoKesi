# フォトケシ - 類似ショット整理

写真をたくさん撮るのは楽しいのに、「ほぼ同じ写真」が端末を圧迫していくのはつらい。そこで、写真整理を負担なく定期的に行うことができるシンプルにデザインされたアプリがフォトケシです。
このアプリは、同じ時間帯に撮られた“よく似た写真”だけを自動で束ね、**最初からベスト1枚にチェックが入った状態**で上下二段の整理ボードに並べます。上段には「残す写真」としてチェック済み写真が並び、下段には「バケツ」として削除候補の写真が並びます。ユーザーは、**チェックが付いたものだけを残す**という単純なルールのまま、**バケツに溜まったものをまとめて空にする**→**最後に確認して削除**まで、一息で片づけられます。

## このアプリのアピールポイント

* **考えなくてよい**：チェック＝残す、バケツ＝消す をアプリ全体で統一。
* **速い**：学習モデルを使わず、軽い指標と段階的探索でサクサク。
* **安心**：端末内完結。外部サービス連携なし、広告なし。削除も 30 日の復元猶予つき。
* **続けやすい**：無料でも毎日 3 回進み、有料プランで回数制限が外れ、スクリーンショット整理などが使える。
* **気持ちよい**：スクリーンショットはスワイプでテンポよく選別。
* **二画面だけ**：メインページと設定ページ。あとは一時的なポップアップのみ。迷路のようなタブはなし。

---

## 対応環境
* iOS 17 / 18 / 26
* 開発・動作は iPhone 実機を前提（M4 Mac mini でビルド／配布）。
   * 開発環境のVSCodeと動作確認用のXcode環境（v26）導入済み

---

## 体験の流れ（メイン画面）

1. アプリを開くと、上下二列の整理ボードに **類似グループを 1 つだけ** 表示します。

   * 画面上部のヘッダーは「< 前へ」「類似グループ: n / N」「次へ >」の三分割レイアウトで構成し、中央テキストは常に中央寄せになります。先頭・末尾のグループでは対応するボタンを自動で非活性化し、時間幅に関する案内は設定画面に集約します。
   * 上段（残す写真）には、サムネイルから計算した簡易ブレ指標（グレースケール勾配の分散）で最もシャープな 1 枚を自動で選定し、チェック済みの状態で `best✨` バッジを重ねて強調します。チェックを外すと即座にバケツへ移動し、別の写真を残す写真に昇格できます。
   * 下段（バケツ）には、チェックが外れている写真が常に集まり、削除候補としてスタンバイします。誤って追加した写真は **上方向のスワイプ** やチェック操作で残す写真に戻せます。
   * 前後の撮影時刻が設定した時間幅内に連鎖して存在する写真だけが束ね対象になり、孤立した 1 枚きりの写真は整理ボードに表示されません。
   * 類似グループは、設定した時間幅の条件に加えて 96px サムネイルから算出した aHash／dHash／pHash の距離と、シーンタイプ別に重み付けした LAB ヒストグラム＋エッジ方向スコアを組み合わせ、閾値ぎりぎりの束だけ軽量 FAST-SSIM で再確認します。これにより風景・人物・料理・自撮りが混在しても高速に束ねられます。
   * 類似グループの探索は常に「現在位置から最大 10 グループ先」までを先読みバッファとして維持し、バッファ残量が 7 を下回るとバックグラウンドで穏やかに補充します。補充は「次へ」を押して前進したタイミング（または一定時間間隔）をトリガーとし、戻る操作では探索済みグループを縮減しません。
   * メイン画面のサムネイルを **タップ** するとフルサイズの元写真ビューに遷移し、右上のトグルでチェックのオン・オフを切り替えられます（結果は即座に上下の列へ反映）。ピンチイン／ピンチアウトで細部を拡大・縮小でき、ダブルタップでリセットする操作にも対応します。フルサイズビューではサムネイル画像を即表示しつつ、バックグラウンドで高解像度写真を追加フェッチしてフェード表示するため、純正アプリに近い解像感を保ちながら待ち時間を抑えています。
   * サムネイル右上のバッジをタップするとチェック（残す）とバケツ（削除候補）が入れ替わり、同じ位置に緑のチェックまたは赤いバケツアイコンが表示されます。
   * バケツへ送った写真はメイン画面でもサムネイルが淡いグレーに変わり、中央に「バケツ送り済み」バッジが表示されます。タップするとバケツから復活し、仕分け対象に戻ります。
   * 元写真ビューでは左上の戻るボタンでサムネ一覧へ戻れるほか、**左右スワイプ** で同じ束の別写真に移動し、**上方向へのスワイプ** でメイン画面へ戻ります。ピンチ操作は拡大に利用できます。
   * 背景には Apple 純正の壁紙トーンを意識した淡いグラデーションを敷き、ガラス調ボタンの透過感が自然に浮き立つようにしています。
   * ヘッダーや主要ボタンは軽量なガラス調（Liquid Glass 風）の表現を採用し、淡い透過色と輪郭線で奥行きと統一感を出しています。
   * 右上の歯車アイコンから設定へ移動し、グルーピング時間幅（15〜240分・15分刻み）の調整に加えて、本日の仕分け残り回数・削除済みデータ量と Free / PhotoKesi MAX の比較表を確認できます。
   * MAX プランでは、グループ表示と同時にベスト写真の上へ吹き出しで理由テキスト（例：手ぶれが少ない、露出が安定している、被写体が中心にある）を表示します。吹き出しはタップと VoiceOver で読み上げに対応し、無料プランでは非表示です。
   * 画面サイズやダイナミックタイプの設定に応じてカードやボタンのサイズを自動調整し、メイン画面はスクロールなしで全ての操作が届くように最適化されています。

2. 右上のチェックやスワイプでバケツを整えたら、右下の **「仕分けを完了して次のグループへ」** ボタンを押します。このボタンは一瞬のアニメーションだけで即座に次のグループへ遷移し、削除確認は発生しません。削除はユーザーが任意のタイミングで、同じ位置に配置された赤い **「バケツを空にする」** ボタンを押してまとめて行います。

* 「仕分けを完了して次のグループへ」は、バケツの中身を保持したまま次の束へシームレスに移動でき、テンポを損ないません。無料プランではこの操作が **1 日 3 回まで**で、上限に達するとポップアップでリセット時刻を案内しつつ、「上限を解除」ボタンから設定画面へ移動できます（0:00 にリセット）。
* グループを仕分けて「仕分けを完了して次のグループへ」を押した瞬間に、そのグループで「残す」が付いていた写真へ永続フラグを保存し、以降の探索・差分スキャンでは同じ写真が再び現れません（リセット操作でのみ解除）。
* 「バケツを空にする」を押したときだけ **削除確認モーダル** が開き、これまでにバケツへ入れた全ての写真を 1 度だけ確認します。バケツに写真がある限り、何度でも削除を実行できます。
  削除候補に含まれるのは「仕分け完了」を押して確定したグループだけで、まだ手を付けていないグループの写真はここには現れません。
  * モーダルは縦スクロールの一覧で、元の類似グループ単位で角丸の枠にまとめて表示するため、「どの束からの写真か」が一目で把握できます。
  * メイン画面の右下にはバケツ残量の丸い赤ボタンと横長の「バケツを空にする」ボタンを並べ、バケツ内の枚数バッジを即座に確認できるようにします。
   * 実際の削除は iPhone の **「最近削除した項目」** に移動するだけなので、**約30日間は復元可能**です。削除確定後は「○枚の写真を『最近削除した項目』に移動しました。写真アプリから復元できます。」という標準風ポップアップを表示します。

3. 進捗表示はヘッダー中央の **「類似グループ: n / 発見済み総数」** で提示します。
   裏で探索が進むため、**右側の母数は 4/35 → 5/42 → 6/43 のように動的に増える** ことがあります。
   進捗表示はシンプルに数字のみとし、探索は前方向への遷移をトリガーに静かに補充されます。

> ポイント：**常に「現在 + 10 グループ」のバッファ**を維持し、最新の写真から優先して価値を出します。補充は前方向への遷移をトリガーに行い、戻る操作では探索済みグループを削らずに即座に再表示できます。

---

## スクリーンショット整理（有料プラン）

メイン画面の左上にある **「スクリーンショット整理」** ボタンでモードを切り替えます。

* 無料プランでボタンを押すと、設定の「サブスクリプション」説明へ遷移して特徴を案内します。
* 有料プランでは、その場で **専用モード** に切り替わり、**背景色やカラーパレット** が変化します（切替に気づきやすい）。

このモードでは、**中央に現在のスクリーンショット**、**下に次の画像の上約 5% が見えている**レイアウトで、
**右スワイプ＝残す、左スワイプ＝削除** の直感的な選別ができます（左右は設定で入れ替え可能）。
一度「残す」にしたスクリーンショットにはフラグが付くので、**再起動後も二度と出ません**。
この「残すフラグ」「リセット」の考え方は、写真の類似グループ整理と**共通の挙動**です。

---

## 料金プラン（家族共有なし）

* **Free（無料）**

  * 類似グループの表示・チェック・バケツ投入は無制限
  * **仕分け操作（「候補をバケツに送って次へ」）は 1 日 3 回まで**（端末の暦で 0 時に自動リセット）
  * バケツを空にする削除は回数制限なし
  * カラーパレット：ホワイト／ダークブルー／ダークグレー
  * スクリーンショット整理モード：利用不可
  * 高精度モード：利用不可
  * 理由吹き出し：表示なし

* **MAX（有料・サブスクリプション）**

  * 価格：**月 700 円**／**年 5,800 円**
  * 仕分け操作の回数制限なし
  * スクリーンショット整理モードが利用可能
  * 高精度モード（類似しきい値の調整域が広がり、判定が安定）
  * ベスト写真に理由吹き出しを表示
  * 週次のレポート通知（今週の削除枚数と推定の節約容量）
  * カラーパレット：Free の 3 色 + パステルブルー／パステルイエロー／パステルグリーン
  * 画面上の文言：**「あなたの操作に応じて、判断が賢くなっていきます！」**

    * 実装は端末内の**重み・しきい値の微調整**のみ（機械学習モデルは使いません）。
    * 無料でも少量の調整は内部で行いますが、あえて告知しません。

**比較表は常時表示**です。設定画面の「サブスクリプション」セクションで、
Free と MAX を**表形式**で並べ、丸×で出来ること／出来ないことを明確に示します。
これにより、**解約を検討するユーザーが失う価値を可視化**し、離脱を抑えます。

---

## 類似判定の仕組み（機械学習なし）

1. **時間の近さ**で粗く束ねます（初期値は撮影時刻 ±1 時間。設定で調整可能）。前後の写真を芋づる式にたどり、連続して時間幅内にあるものだけを同じ束にします。孤立した写真は束に含めず、整理ボードにも表示しません。
2. 画像を 96px まで縮小し、次の情報を計算して**見た目の近さ**を測ります。

   * **平均／差分／知覚ハッシュ**（aHash／dHash／pHash）のハミング距離
   * **LAB 12bin ヒストグラム距離**と **エッジ方向ヒストグラム**（写真タイプに応じて重みを切り替え）
   * 閾値境界のグループだけ、4×4 グリッドでサンプリングした **FAST-SSIM**
3. そのグループの中から **ベスト1枚** を選びます（最初からチェックが入る）。

   * 顔領域の比率、彩度分布、輝度勾配を基に写真タイプを推定し、シャープネス・露出・ノイズ・構図中心度・グループ代表性の重みをタイプ別に切り替えます。
   * MAX プランでは、タイプ別テンプレートから生成した理由をベスト写真上の吹き出しで提示し、VoiceOver 読み上げにも登録します。

> すべて端末内で完結します。写真データや指標はアプリの領域に暗号化して保存し、外部へ送信しません。

---

## バックグラウンドと負荷対策

* 進捗の右側の母数は、**探索が進むほど増えていく**設計です。
* 裏側の処理は突き詰めた差分スキャンを基本とし、無制限に新規ジョブを立ち上げずに 10 グループ分のバッファを維持します。
* iOS の制約に合わせてバックグラウンド実行は控えめにし、**通知からの起動時**に差分だけ素早く処理します。

---

## フラグとリセット

* グループを仕分けて次の束へ進んだ時点で、「残す」にした写真やスクリーンショットには **フラグ** を付け、**再表示しません**。
* 写真の `localIdentifier` と知覚ハッシュ／差分ハッシュを端末内に永続保存し、再起動後も「残す」判定を維持します。識別子が変わる場合に備え、**知覚ハッシュによる再照合**も使って誤再出現を抑えます。
* メインもスクリーンショット整理も、**同じデザインの「リセット」ボタン**を用意します。
  押すと確認ダイアログが出て、OK でフラグを全消去し、**再び全件が対象**に戻ります。

---

## 設定画面にあるもの（抜粋）

* 課金関連カード
  * 本日の仕分け進捗：残り回数、仕分け回数、削除データ量をまとめて表示
  * PhotoKesi プラン比較：Free／MAX の機能差を丸×で表示
  * 「『残す』フラグをリセット」ボタンで確定済みの写真を再探索に戻し、確認後に即時リロードする
* グルーピングの設定（時間幅）
* カラーパレット選択（Free: ホワイト／ダークブルー／ダークグレー、MAX: パステルブルー／パステルイエロー／パステルグリーン）
* これまでに削除して浮いた容量の合計（推定値）
* 類似判定の時間幅（初期 1 時間、15 分刻みで調整可能）
* 類似の強さ（低め／標準／強め）
* 通知（週 1 の棚卸し通知、未処理しきい値での通知）
* 整理対象の種類（写真／スクリーンショット）
* 判定のリセット（メイン／スクリーンショット共通）

---

## プライバシーと安全

* すべての計算と記録は **端末内** で行い、写真データを外部へ送りません。
* 初回起動時に写真ライブラリへのアクセス許可をリクエストし、限定アクセスでも利用を開始できます。設定アプリへの導線を用意し、完全アクセスを案内します。
* 削除は iPhone の **「最近削除した項目」** に移動するだけなので、**約30日間は復元可能**です。
* 誤操作が不安な人のために、削除前の **確認モーダル** を必須にしています。

---

## 非目標（当面やらないこと）

* クラウド連携、他社サービス連携
* 複雑な編集やレタッチ
* 写真以外のメディア（動画の高度編集など）の整理
* 端末状態（低電力・高温など）に応じて探索を自動スロットリングする高度な負荷制御

---

## ライセンス・表記（案）

* アプリ内の「応援」リンクは任意で、機能とは連動しません。
* 商用利用に支障のないライブラリ（ハッシュ計算など）を選定し、第三者の権利に配慮します。

---

## 開発メモ

### 基本構成メモ

* フレームワーク：PhotoKit、Core Image、Accelerate（vImage / vDSP）
* サムネイル取得は `PhotoThumbnailCache` が `PHCachingImageManager` と `NSCache` を組み合わせ、非同期で縮小画像をキャッシュする。
* `PhotoLibraryViewModel` が `PHAsset` のフェッチとサムネイルの公開を担い、UI は実データを表示する。
* フルスクリーン表示では `PhotoFullImageLoader` が画面スケールに合わせた高解像度画像を段階取得し、サムネイル→高品質画像へのフェードと近傍キャッシュで軽量化を図る。
* 類似度解析ユーティリティ `PhotoSimilarityAnalyzer` が 96px サムネから aHash／dHash／pHash と LAB ヒストグラム＋エッジ方向ヒストグラムを算出し、FAST-SSIM を閾値境界の束だけに適用する二段構成でグループ化とベスト判定を支える。ベスト判定はタイプ別スコアと理由テンプレート生成まで担う。
* データ保存：アプリ内に暗号化して保存（指標やフラグ、統計値）
* 例外系：権限が限定のときでも最小限で動作し、完全アクセスを丁寧に案内
* 値型や設定用データ構造を拡張する際は、既存のメンバーイニシャライザがそのまま呼び出せることを優先し、必要なら明示的なイニシャライザを追加して互換性を担保する。呼び出し側の引数リストが突然増える設計変更を避けることが、ビルドエラーの多くを未然に防ぐ最短ルート。

### ローディング体験の方針

* アプリ起動時は SwiftUI 標準コンポーネントのみで構成したローディング画面を表示し、アプリ名・簡単な進行説明・システムインジケータ程度に留めます。権限確認や初回フェッチが完了したら速やかにメイン画面へ遷移します。
* サムネイルが揃うまでの短時間は上下二列レイアウトに合わせたスケルトンビューを表示し、`redacted(reason: .placeholder)` や単色の矩形コンポーネントで軽量に表現します。ビュー階層はメイン画面構造を流用し、表示・非表示の切り替えで後続の仕様変更にも対応しやすくします。
* 状態管理は既存の ViewModel にブール値を足す程度で制御し、アプリ全体のレスポンスを損なわないことを優先します。

### フルスクリーンビュー操作の指針

* ピンチズームとページ送り（`TabView(.page)`）を同時に成立させるため、ズーム処理は `UIScrollView` を `UIViewRepresentable` で薄くラップした `ZoomableImageView` を利用する。SwiftUI 純正ジェスチャーでの再実装は禁止。
* `ZoomableImageView` から受け取る `zoomScale` バインディングをメイン画面側で監視し、ズーム中は下スワイプクローズを抑止する。ズーム倍率 1.0 に戻ったら辞書をリセットして TabView のスワイプに干渉しない。
* 拡張時の追加ジェスチャーが必要になった場合も、`UIGestureRecognizerRepresentable` など UIKit ベースの橋渡しを優先し、SwiftUI カスタムジェスチャーの多重合成は避ける。
* ユーザー向けテキストは常に直感的な言い回しを優先し、デバッグ用語（例：チェック状態、バケツなど内部用語のみの羅列）で終わらせない。UI変更時は README と実装を同時に更新する。

### ビルドテスト

XCodeを使わずに下記の方法でビルドが通るか簡易的に確認できます。

1. `bash scripts/ios_build_check.sh --project "PhotoKesi.xcodeproj"`をターミナルで実行
2. ビルド完了まで少し待つ
3. `.build/build.json`（LLM向け）または`.build/build_issues.txt`（人間用）を確認してビルドの成否とエラー内容を確認する

---
