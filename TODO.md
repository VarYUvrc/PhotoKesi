## TODO.md

> コーディングエージェントは、この順序でスモールスタートしてください。
> 各ステップは **動作確認のための一時ボタンやダミー画面** を許容します。
> 先に全機能を抱え込むのではなく、**写真の読み込み→一つのグループ→削除確認** までを最速で通し、その後に精度や快適さを足していきます。

### スモールステップ計画（着手前準備）

* [x] S0: Xcode で PhotoKesi プロジェクトを開き、シミュレータまたは実機でテンプレートのままビルドと実行が成功することを確認する。
* [x] S1: SwiftUI のメイン画面にダミー写真カード（色付き矩形や SF Symbols）を 3 枚並べ、タップでチェック状態を切り替える簡易挙動を確認する。
* [x] S2: 仮の「チェック以外をバケツへ」ボタンを配置し、押下時に Alert でメッセージを表示するだけのフローを実装して UI イベントが動くことを確認する。
* [x] S3: 仮の削除確認モーダル画面（ダミーリストと確定ボタンのみ）を実装し、メイン画面からの遷移と戻りが成立することを確かめる。
* [x] S4: 上記ダミー UI を支える簡易 ViewModel を用意し、チェック状態やバケツ送りフラグが一箇所で管理できることを確認する。
    * [x] ViewModel 用のデータ構造を定義し、ObservableObjectとして公開する
    * [x] ContentViewからViewModelを利用するよう接続する
    * [x] 削除確認シートがViewModelの状態を参照するよう更新する

### フェーズA：最小の価値を最速で出す（削除まで一周）

* [x] A1: 写真ライブラリ権限の取得。限定アクセスでも起動でき、完全アクセスの案内を用意する。
    * [x] A1-1: 写真ライブラリ権限状態を監視・更新するViewModelを追加する。
    * [x] A1-2: ContentViewで権限状態に応じた画面分岐と許可リクエスト導線を実装する。
    * [x] A1-3: 限定アクセスや拒否時の完全アクセス案内UIと設定遷移ボタンを用意する。
    * [x] A1-4: 実装後にTODOとREADMEの記載を最新状態に追従させる。
* [x] A2: サムネイルの縮小キャッシュを作る（非同期、エラー時はスキップ）。
    * [x] PhotoThumbnailCacheサービスを実装
    * [x] PhotoLibraryViewModelでフェッチとサムネイル取得を行う
    * [x] ContentViewでPhotoLibraryViewModelを利用し実サムネイルを表示する
    * [x] A2-4: アプリ起動直後からサムネイルフェッチ体制が整うまでの間に表示する、SwiftUIだけで構成した軽量なローディング画面を用意する（外部ライブラリや重いアニメーションは避ける）。
* [x] A3: 撮影時刻が近い写真を簡易に束ねる（デフォルトは撮影時刻 ±1 時間、設定で調整可能）。
    * [x] A3-1: 撮影時刻順に写真を取得し、±1 時間以内をまとめた暫定グループを生成する。
    * [x] A3-2: メイン画面右上に設定ボタンを追加して設定画面へ遷移可能にする。
    * [x] A3-3: 設定画面に時間幅（分単位）の調整UIを追加し、ViewModelと連携する。
    * [x] A3-4: 調整した時間幅をメイン画面側のグループ生成に反映する。
    * [x] A3-5: 前後"±時間幅"に写真が存在しない孤立写真は束ね対象から除外し、連鎖的に時間幅内の写真をたどってグループを形成する。
* [x] A4: **メイン画面** に上下二列レイアウトでグループを表示し、上段は残す写真（`best✨` バッジ付きのベストショットを初期設定）、下段は常時バケツとして扱う。**チェック＝残す**を実装。
    * [x] A4-1: 上段の残す写真にグループ先頭の1枚をベストショットとして固定し、`best✨` バッジとチェック表示を同期させる。
    * [x] A4-2: 下段のバケツにバケツ内写真が自動で集まるようにし、チェック操作やスワイプで列間を移動できるようにする。
    * [x] A4-3: バケツ状態を示すバッジや上下方向スワイプのジェスチャで、誤操作からの戻しを実装する。
    * [x] A4-4: グループ生成やサムネイル取得が完了するまで、上下二列構成に合わせたスケルトンプレースホルダを表示する（`redacted` や単色矩形を活用し、追加素材は用いない）。
    * [x] A4-5: サムネイルをタップした際にフルサイズビューを表示し、右上トグルでチェックを切り替えられるようにする（左上にメイン画面へ戻るボタンを配置）。
    * [x] A4-6: フルサイズビューで左右スワイプによる画像切替と上方向スワイプでメイン画面へ戻るジェスチャを実装する。
    * [x] A4-7: 画面サイズやダイナミックタイプに応じてカードとボタンを自動リサイズし、スクロールなしで操作が収まるようレイアウトを最適化する。
* [ ] A5: 同一束の中で、知覚ハッシュと差分ハッシュの距離を計算し、最初の **類似グループを 1 つ** 作る。
* [ ] A6: ベスト1枚を単純指標で選ぶ（ブレの少なさのみ等、まずは一指標から）。
* [x] A7: **「仕分けを完了して次のグループへ」** ボタンと削除確認モーダル→削除確定→次グループ遷移のフローを実装。
    * [x] A7-1: 削除確認モーダルでバケツ内容を確認・調整できるようにし、確定後は仕分け完了から次のグループへ進む挙動（バケツが空のときは即座に遷移）を組み立てる。
* [ ] A8: 削除は **「最近削除した項目」へ移動** にとどめ、完了ポップアップを表示。
* [ ] A9: 無料プランの **日次 3 回カウント** を実装（0 時リセット）。
* [ ] A10: 設定画面の **サブスクリプション比較表（ダミー）** と「本日の残り回数」を表示。

> A フェーズの受け入れ基準：
> アプリを開いて **1 つの類似グループを見て、残す写真とバケツを整理し、仕分けを完了して削除** まで通る。
> 無料で **削除確定が 3 回に制限** されている。

### フェーズB：探索を広げ、動的進捗にする

* [ ] B1: 類似グループの探索を **段階的パイプライン** に分割し、最新写真から優先して発見する。
* [ ] B2: **進捗表示を「現在 / 発見済み総数」** にし、裏の探索に応じて右側の母数が増えるようにする。
* [ ] B3: 負荷制御（同時実行数、熱、電池、操作中の一時停止）を実装。
* [ ] B4: 差分スキャンを実装し、二回目以降は新規のみを処理。
* [ ] B5: グループ間の移動（前へ／次へ）を実装。

### フェーズC：精度と安心を上げる

* [ ] C1: 類似判定に **色ヒストグラム距離** と **簡易 SSIM** を追加（必要時のみ評価する分岐）。
* [ ] C2: ベスト選定に **露出**・**構図の中心度**・**ノイズ**・**グループ中心性** を加える。
* [ ] C3: **理由バッジ** を有料時に表示。
* [ ] C4: 「残す」フラグと再出現防止（識別子＋知覚ハッシュ照合）を実装。
* [ ] C5: **リセット** ボタンをメインとスクリーンショット整理で共通デザインにする。

### フェーズD：スクリーンショット整理（有料）

* [ ] D1: スクリーンショットの抽出（スマートアルバム／メディアサブタイプ）。
* [ ] D2: モード切替ボタン（無料は課金説明へ、有料は即切替）。**切替時の配色** を変更。
* [ ] D3: **左右スワイプ** で残す／削除の判定、**下に次の画像の上 5%** が見えるレイアウト。
* [ ] D4: 左右の入れ替えオプション（設定）。
* [ ] D5: スクリーンショットにも「残す」フラグとリセットを適用。

### フェーズE：課金と通知

* [ ] E1: サブスクリプションの実装（購入・復元・解約導線）。
* [ ] E2: 設定の比較表を **常時** 表示し、Free／MAX を丸×で示す。
* [ ] E3: 週 1 のレポート通知（有料のみ）。
* [ ] E4: 未処理しきい値での通知（オフラインでも動作）。
* [ ] E5: 「これまでに削除して浮いた容量（推定）」の集計と表示。

### フェーズF：仕上げ

* [ ] F1: 初回チュートリアル（チェック＝残す、30 日復元できる、安全性の説明）。
* [ ] F2: ハプティックの追加（チェック切替、削除確定、スワイプ決定）。
* [ ] F3: アクセシビリティ（ダイナミックタイプ、コントラスト、タップ領域）。
* [ ] F4: エラー時の穏当なフォールバック（計算不能な写真はスキップし、進捗は止めない）。
* [ ] F5: 端末内のデータ暗号化とクリーンアップ処理。
* [ ] F6: ストア申請用の文面（端末内完結、復元可能、安全設計、二画面のシンプルさ）を用意。

---

この順序で実装すれば、**まずは 1 グループを安全に削除まで通す最小価値**がすぐに動き、
そのあとで探索の広がり・精度・快適さ・課金・通知を **段階的に追加** できます。
読み手がゼロ知識でも、「どう使うか」「どう作るか」が自然に想像でき、
**ダウンロードしたくなる理由**が明確になることを目指した仕様です。
