## TODO.md

> コーディングエージェントは、この順序でスモールスタートしてください。
> 各ステップは **動作確認のための一時ボタンやダミー画面** を許容します。
> 先に全機能を抱え込むのではなく、**写真の読み込み→一つのグループ→削除確認** までを最速で通し、その後に精度や快適さを足していきます。

### スモールステップ計画（着手前準備）

* [x] S0: Xcode で PhotoKesi プロジェクトを開き、シミュレータまたは実機でテンプレートのままビルドと実行が成功することを確認する。
* [x] S1: SwiftUI のメイン画面にダミー写真カード（色付き矩形や SF Symbols）を 3 枚並べ、タップでチェック状態を切り替える簡易挙動を確認する。
* [x] S2: 仮の「チェック以外をバケツへ」ボタンを配置し、押下時に Alert でメッセージを表示するだけのフローを実装して UI イベントが動くことを確認する。
* [x] S3: 仮の削除確認モーダル画面（ダミーリストと確定ボタンのみ）を実装し、メイン画面からの遷移と戻りが成立することを確かめる。
* [x] S4: 上記ダミー UI を支える簡易 ViewModel を用意し、チェック状態やバケツ送りフラグが一箇所で管理できることを確認する。
    * [x] ViewModel 用のデータ構造を定義し、ObservableObjectとして公開する
    * [x] ContentViewからViewModelを利用するよう接続する
    * [x] 削除確認シートがViewModelの状態を参照するよう更新する

### フェーズA：最小の価値を最速で出す（削除まで一周）

* [x] A1: 写真ライブラリ権限の取得。限定アクセスでも起動でき、完全アクセスの案内を用意する。
    * [x] A1-1: 写真ライブラリ権限状態を監視・更新するViewModelを追加する。
    * [x] A1-2: ContentViewで権限状態に応じた画面分岐と許可リクエスト導線を実装する。
    * [x] A1-3: 限定アクセスや拒否時の完全アクセス案内UIと設定遷移ボタンを用意する。
    * [x] A1-4: 実装後にTODOとREADMEの記載を最新状態に追従させる。
* [x] A2: サムネイルの縮小キャッシュを作る（非同期、エラー時はスキップ）。
    * [x] PhotoThumbnailCacheサービスを実装
    * [x] PhotoLibraryViewModelでフェッチとサムネイル取得を行う
    * [x] ContentViewでPhotoLibraryViewModelを利用し実サムネイルを表示する
    * [x] A2-4: アプリ起動直後からサムネイルフェッチ体制が整うまでの間に表示する、SwiftUIだけで構成した軽量なローディング画面を用意する（外部ライブラリや重いアニメーションは避ける）。
* [x] A3: 撮影時刻が近い写真を簡易に束ねる（デフォルトは撮影時刻 ±1 時間、設定で調整可能）。
    * [x] A3-1: 撮影時刻順に写真を取得し、±1 時間以内をまとめた暫定グループを生成する。
    * [x] A3-2: メイン画面右上に設定ボタンを追加して設定画面へ遷移可能にする。
    * [x] A3-3: 設定画面に時間幅（分単位）の調整UIを追加し、ViewModelと連携する。
    * [x] A3-4: 調整した時間幅をメイン画面側のグループ生成に反映する。
    * [x] A3-5: 前後"±時間幅"に写真が存在しない孤立写真は束ね対象から除外し、連鎖的に時間幅内の写真をたどってグループを形成する。
* [x] A4: **メイン画面** に上下二列レイアウトでグループを表示し、上段は残す写真（`best✨` バッジ付きのベストショットを初期設定）、下段は常時バケツとして扱う。**チェック＝残す**を実装。
    * [x] A4-1: 上段の残す写真にグループ先頭の1枚をベストショットとして固定し、`best✨` バッジとチェック表示を同期させる。
    * [x] A4-2: 下段のバケツにバケツ内写真が自動で集まるようにし、チェック操作やスワイプで列間を移動できるようにする。
    * [x] A4-3: バケツ状態を示すバッジや上下方向スワイプのジェスチャで、誤操作からの戻しを実装する。
    * [x] A4-4: グループ生成やサムネイル取得が完了するまで、上下二列構成に合わせたスケルトンプレースホルダを表示する（`redacted` や単色矩形を活用し、追加素材は用いない）。
    * [x] A4-5: サムネイルをタップした際にフルサイズビューを表示し、右上トグルでチェックを切り替えられるようにする（左上にメイン画面へ戻るボタンを配置）。
    * [x] A4-6: フルサイズビューで左右スワイプによる画像切替と上方向スワイプでメイン画面へ戻るジェスチャを実装する。
    * [x] A4-7: 画面サイズやダイナミックタイプに応じてカードとボタンを自動リサイズし、スクロールなしで操作が収まるようレイアウトを最適化する。
* [x] A5+A6: 知覚ハッシュと差分ハッシュによる類似グループ生成とベストショット自動選定を行う。
    * [x] A5+A6-1: サムネイル画像から知覚ハッシュ・差分ハッシュと簡易ブレ指標を算出するユーティリティを実装する。
    * [x] A5+A6-2: ハッシュ距離と撮影時間を組み合わせた類似グループ化ロジックを組み込み、最初の類似グループを生成・保持する。
    * [x] A5+A6-3: ブレ指標を用いてベストショットを自動選定し、ViewModelとUIに反映する。
* [x] A5+A6-補: フルスクリーンビューの高解像度読み込みを段階表示（サムネ即表示→高品質画像フェード）で実装し、表示品質とパフォーマンスを両立させる。
    * [x] A5+A6-補-1: フルスクリーン表示を `UIScrollView` ベースのズームビューに刷新し、ピンチズームとページングスワイプを自然に両立させる。
* [x] A7: **「仕分けを完了して次のグループへ」** ボタンと削除確認モーダル→削除確定→次グループ遷移のフローを実装。
    * [x] A7-1: 削除確認モーダルでバケツ内容を確認・調整できるようにし、確定後は仕分け完了から次のグループへ進む挙動（バケツが空のときは即座に遷移）を組み立てる。
* [x] A7-改: グループ遷移とバケツ削除を分離し、複数グループを跨いだ一括削除に対応する。
    * [x] A7-改-1: 「仕分けを完了して次のグループへ」ボタンを押した際にバケツを空にせず即座に次グループへ遷移するようロジックを変更する。
    * [x] A7-改-2: 緑ボタンの直下に赤色の「バケツを空にする」ボタンを追加し、押下時のみ削除確認モーダルを開くようにする。
    * [x] A7-改-3: 削除確認モーダルで全グループ分のバケツ写真をまとめて表示し、元グループごとに枠線で区切った縦スクロールリストにする。
    * [x] A7-改-4: 一括削除確定後に全バケツ項目をViewModelから除去し、空状態を反映する。
    * [x] A7-改-5: 「仕分け完了」済みグループだけがバケツ対象になるよう状態管理を見直し、未仕分けグループの写真が削除候補に混ざらないようにする。
* [x] A8: 削除は **「最近削除した項目」へ移動** にとどめ、完了ポップアップを表示。
    * [x] A8-1: PHAssetChangeRequest.deleteAssetsでバケツ写真を「最近削除した項目」へ移す処理を実装する。
    * [x] A8-2: 削除完了後に成功ポップアップを表示し、移動先を案内する。
* [x] A9: 無料プランの **日次 3 回カウント（仕分け操作）** を実装（0 時リセット）。
    * [x] A9-1: 無料プランの日次仕分け回数をUserDefaultsで管理し、0時リセットする。
    * [x] A9-2: 残り回数が0のときは仕分け操作を抑止し、設定画面へ誘導する。
* [x] A10: 設定画面の **サブスクリプション比較表（ダミー）** と「本日の残り回数」を表示。
    * [x] A10-1: 設定画面に本日の残り回数表示を追加する。
    * [x] A10-2: 有料プラン比較のダミーテーブルを表示し、制限解除を明示する。
* [x] A11: バケツ残量を示す丸ボタンと「バケツを空にする」ボタンのレイアウトを刷新し、残数バッジを常時表示する。

> A フェーズの受け入れ基準：
> アプリを開いて **1 つの類似グループを見て、残す写真とバケツを整理し、仕分けを完了して削除** まで通る。
> 無料で **削除確定が 3 回に制限** されている。

### フェーズB：探索を広げ、動的進捗にする

* [x] B1: グループ間の移動 UI を刷新し、ヘッダーの情報設計を見直す。
    * [x] B1-1: 上部ヘッダーを「< 前へ」「現在のグループ: n / N」「次へ >」の 3 分割で中央寄せし、タップターゲットを最適化する。
    * [x] B1-2: 時間幅に関する情報は設定画面へ集約し、メイン画面のヘッダー文言を整理する。
    * [x] B1-3: 先頭／末尾グループでのボタン非活性とダイナミックタイプ適合、VoiceOver 読み上げを検証する。
* [x] B2: 類似グループ探索を「現在位置 + 最大 10 グループ」のバッファで段階化する。
    * [x] B2-1: 既存の探索ロジックとキャッシュ構造を精査し、バッファ維持に必要なキューと状態遷移を設計する。
    * [x] B2-2: アプリ起動時に現在グループと 10 グループ分の先読みを確保するフェッチパイプラインを実装する。
    * [x] B2-3: 「次へ」遷移を主トリガーにバッファ補充を行い、余剰探索を防ぐ停止条件を組み込む（戻る操作時に探索済みグループを縮減しない）。
    * [x] B2-4: 仕分け完了済みグループのキャッシュを破棄し、バッファサイズを一定に保つクリーンアップ処理を追加する。
    * [x] B2-5: 段階探索の状態（残バッファ数・探索中フラグ）を ViewModel へ公開し、後続の進捗表示が購読できるようにする。
* [x] B3: **進捗表示を「現在 / 発見済み総数」** に連動させ、バッファの変化を即時反映する。
    * [x] B3-1: 探索イベントを購読する `ProgressModel`（仮）を実装し、右側の母数をリアルタイム更新する。
    * [x] B3-2: 探索中インジケータと説明ツールチップをバッファ更新と同期させ、待機・停止状態を明示する。
    * [x] B3-3: バッファが一時停止した際のフォールバック文言と再開トリガーを整理する。
* [ ] B4: 一度残すと判定した写真を再度グループ化しないようフラグ管理を導入する。
    * [ ] B4-1: グループ内で「残す」と確定した写真に付与する永続フラグのスキーマと保存先を設計する。
    * [ ] B4-2: グルーピング時にフラグ済み写真を探索対象から除外するフィルター処理を組み込む。
    * [ ] B4-3: フラグ解除やリセット導線を用意し、誤判定時の復旧手順を定義する。

### フェーズC：精度と安心を上げる

* [ ] C1: 類似判定に **色ヒストグラム距離** と **簡易 SSIM** を追加（必要時のみ評価する分岐）。
* [ ] C2: ベスト選定に **露出**・**構図の中心度**・**ノイズ**・**グループ中心性** を加える。
* [ ] C3: **理由バッジ** を有料時に表示。
* [ ] C4: 「残す」フラグと再出現防止（識別子＋知覚ハッシュ照合）を実装。
* [ ] C5: **リセット** ボタンをメインとスクリーンショット整理で共通デザインにする。

### フェーズD：スクリーンショット整理（有料）

* [ ] D1: スクリーンショットの抽出（スマートアルバム／メディアサブタイプ）。
* [ ] D2: モード切替ボタン（無料は課金説明へ、有料は即切替）。**切替時の配色** を変更。
* [ ] D3: **左右スワイプ** で残す／削除の判定、**下に次の画像の上 5%** が見えるレイアウト。
* [ ] D4: 左右の入れ替えオプション（設定）。
* [ ] D5: スクリーンショットにも「残す」フラグとリセットを適用。

### フェーズE：課金と通知

* [ ] E1: サブスクリプションの実装（購入・復元・解約導線）。
* [ ] E2: 設定の比較表を **常時** 表示し、Free／MAX を丸×で示す。
    * [ ] E2-1: カラーパレット選択UIを実装し、Freeはホワイト／ダークブルー／ダークグレー、MAXはパステルブルー／パステルイエロー／パステルグリーンを解放する。
    * [ ] E2-2: 無料プラン時は追加カラーパレットに打ち消し線・ロック表示を加え、有料プランで選択可能にする。
* [ ] E3: 週 1 のレポート通知（有料のみ）。
* [ ] E4: 未処理しきい値での通知（オフラインでも動作）。
* [ ] E5: 「これまでに削除して浮いた容量（推定）」の集計と表示。
    * [ ] E5-1: 本日／累計で削除した写真のデータ量を集計し、設定画面のダミー値を実データに置き換える。

### フェーズF：仕上げ

* [ ] F1: 初回チュートリアル（チェック＝残す、30 日復元できる、安全性の説明）。
* [ ] F2: ハプティックの追加（チェック切替、削除確定、スワイプ決定）。
* [ ] F3: アクセシビリティ（ダイナミックタイプ、コントラスト、タップ領域）。
* [ ] F4: エラー時の穏当なフォールバック（計算不能な写真はスキップし、進捗は止めない）。
* [ ] F5: 端末内のデータ暗号化とクリーンアップ処理。
* [ ] F6: ストア申請用の文面（端末内完結、復元可能、安全設計、二画面のシンプルさ）を用意。
* [ ] F7: メイン画面下部にバケツアイコンを配置し、削除確定時にバケツ送り候補の写真がアイコンへ吸い込まれるアニメーションを追加する。
* [ ] F8: 残す候補／バケツ送り候補間の上下スワイプ時に、カードが上下列を滑らかに移動するアニメーション（一般的なスワイプ移動演出）を実装する。

---

この順序で実装すれば、**まずは 1 グループを安全に削除まで通す最小価値**がすぐに動き、
そのあとで探索の広がり・精度・快適さ・課金・通知を **段階的に追加** できます。
読み手がゼロ知識でも、「どう使うか」「どう作るか」が自然に想像でき、
**ダウンロードしたくなる理由**が明確になることを目指した仕様です。
